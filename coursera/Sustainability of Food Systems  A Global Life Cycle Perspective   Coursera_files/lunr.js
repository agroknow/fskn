define([],function(){var e=function(t){var o=new e.Index;return o.pipeline.add(e.stopWordFilter,e.stemmer),t&&t.call(o,o),o};return e.version="0.3.0",e.tokenizer=function(e){if(Array.isArray(e))return e;for(var e=e.replace(/^\s+/,""),t=e.length-1;t>=0;t--)if(/\S/.test(e.charAt(t))){e=e.substring(0,t+1);break}return e.split(/\s+/).map(function(e){return e.replace(/^\W+/,"").replace(/\W+$/,"").toLowerCase()})},e.Pipeline=function(){this._stack=[]},e.Pipeline.registeredFunctions={},e.Pipeline.registerFunction=function(t,o){console&&console.warn&&o in this.registeredFunctions&&console.warn("Overwriting existing registered function: "+o),t.label=o,e.Pipeline.registeredFunctions[t.label]=t},e.Pipeline.warnIfFunctionNotRegistered=function(e){var t=e.label&&e.label in this.registeredFunctions;!t&&console&&console.warn&&console.warn("Function is not registered with pipeline. This may cause problems when serialising the index.\n",e)},e.Pipeline.load=function(t){var o=new e.Pipeline;return t.forEach(function(t){var n=e.Pipeline.registeredFunctions[t];if(!n)throw Error("Cannot load un-registered function: "+t);o.add(n)}),o},e.Pipeline.prototype.add=function(){var t=Array.prototype.slice.call(arguments);t.forEach(function(t){e.Pipeline.warnIfFunctionNotRegistered(t),this._stack.push(t)},this)},e.Pipeline.prototype.after=function(t,o){e.Pipeline.warnIfFunctionNotRegistered(o);var n=this._stack.indexOf(t)+1;this._stack.splice(n,0,o)},e.Pipeline.prototype.before=function(t,o){e.Pipeline.warnIfFunctionNotRegistered(o);var n=this._stack.indexOf(t);this._stack.splice(n,0,o)},e.Pipeline.prototype.remove=function(e){var t=this._stack.indexOf(e);this._stack.splice(t,1)},e.Pipeline.prototype.run=function(e){for(var t=[],o=e.length,n=this._stack.length,i=0;o>i;i++){for(var r=e[i],s=0;n>s&&(r=this._stack[s](r,i,e),void 0!==r);s++);void 0!==r&&t.push(r)}return t},e.Pipeline.prototype.toJSON=function(){return this._stack.map(function(t){return e.Pipeline.warnIfFunctionNotRegistered(t),t.label})},e.Vector=function(e){this.elements=e;for(var t=0;e.length>t;t++)t in this.elements||(this.elements[t]=0)},e.Vector.prototype.magnitude=function(){if(this._magnitude)return this._magnitude;for(var e,t=0,o=this.elements,n=o.length,i=0;n>i;i++)e=o[i],t+=e*e;return this._magnitude=Math.sqrt(t)},e.Vector.prototype.dot=function(e){for(var t=this.elements,o=e.elements,n=t.length,i=0,r=0;n>r;r++)i+=t[r]*o[r];return i},e.Vector.prototype.similarity=function(e){return this.dot(e)/(this.magnitude()*e.magnitude())},e.Vector.prototype.toArray=function(){return this.elements},e.SortedSet=function(){this.length=0,this.elements=[]},e.SortedSet.load=function(e){var t=new this;return t.elements=e,t.length=e.length,t},e.SortedSet.prototype.add=function(){Array.prototype.slice.call(arguments).forEach(function(e){~this.indexOf(e)||this.elements.splice(this.locationFor(e),0,e)},this),this.length=this.elements.length},e.SortedSet.prototype.toArray=function(){return this.elements.slice()},e.SortedSet.prototype.map=function(e,t){return this.elements.map(e,t)},e.SortedSet.prototype.forEach=function(e,t){return this.elements.forEach(e,t)},e.SortedSet.prototype.indexOf=function(e,t,o){var t=t||0,o=o||this.elements.length,n=o-t,i=t+Math.floor(n/2),r=this.elements[i];return 1>=n?r===e?i:-1:e>r?this.indexOf(e,i,o):r>e?this.indexOf(e,t,i):r===e?i:void 0},e.SortedSet.prototype.locationFor=function(e,t,o){var t=t||0,o=o||this.elements.length,n=o-t,i=t+Math.floor(n/2),r=this.elements[i];if(1>=n){if(r>e)return i;if(e>r)return i+1}return e>r?this.locationFor(e,i,o):r>e?this.locationFor(e,t,i):void 0},e.SortedSet.prototype.intersect=function(t){for(var o=new e.SortedSet,n=0,i=0,r=this.length,s=t.length,a=this.elements,l=t.elements;;){if(n>r-1||i>s-1)break;a[n]!==l[i]?a[n]<l[i]?n++:a[n]>l[i]&&i++:(o.add(a[n]),n++,i++)}return o},e.SortedSet.prototype.clone=function(){var t=new e.SortedSet;return t.elements=this.toArray(),t.length=t.elements.length,t},e.SortedSet.prototype.union=function(e){var t,o,n;return this.length>=e.length?(t=this,o=e):(t=e,o=this),n=t.clone(),n.add.apply(n,o.toArray()),n},e.SortedSet.prototype.toJSON=function(){return this.toArray()},e.Index=function(){this._fields=[],this._ref="id",this.pipeline=new e.Pipeline,this.documentStore=new e.Store,this.tokenStore=new e.TokenStore,this.corpusTokens=new e.SortedSet},e.Index.load=function(t){t.version!==e.version&&console&&console.warn&&console.warn("version mismatch: current "+e.version+" importing "+t.version);var o=new this;return o._fields=t.fields,o._ref=t.ref,o.documentStore=e.Store.load(t.documentStore),o.tokenStore=e.TokenStore.load(t.tokenStore),o.corpusTokens=e.SortedSet.load(t.corpusTokens),o.pipeline=e.Pipeline.load(t.pipeline),o},e.Index.prototype.field=function(e,t){var t=t||{},o={name:e,boost:t.boost||1};return this._fields.push(o),this},e.Index.prototype.ref=function(e){return this._ref=e,this},e.Index.prototype.add=function(t){var o={},n=new e.SortedSet,i=t[this._ref];this._fields.forEach(function(i){var r=this.pipeline.run(e.tokenizer(t[i.name]));o[i.name]=r,e.SortedSet.prototype.add.apply(n,r)},this),this.documentStore.set(i,n),e.SortedSet.prototype.add.apply(this.corpusTokens,n.toArray());for(var r=0;n.length>r;r++){var s=n.elements[r],a=this._fields.reduce(function(e,t){var n=o[t.name].filter(function(e){return e===s}).length,i=o[t.name].length;return e+n/i*t.boost},0);this.tokenStore.add(s,{ref:i,tf:a})}},e.Index.prototype.remove=function(e){var t=e[this._ref],o=this.documentStore.get(t);this.documentStore.remove(t),o.forEach(function(e){this.tokenStore.remove(e,t)},this)},e.Index.prototype.update=function(e){this.remove(e),this.add(e)},e.Index.prototype.idf=function(e){var t=Object.keys(this.tokenStore.get(e)).length;return 0===t?1:1+Math.log(this.tokenStore.length/t)},e.Index.prototype.search=function(t){var o=this.pipeline.run(e.tokenizer(t)),n=Array(this.corpusTokens.length),i=[],r=this._fields.reduce(function(e,t){return e+t.boost},0),s=o.some(function(e){return this.tokenStore.has(e)},this);if(!s)return[];o.forEach(function(t,o,s){var a=1/s.length*this._fields.length*r,l=this,h=this.tokenStore.expand(t).reduce(function(o,i){var r=l.corpusTokens.indexOf(i),s=l.idf(i),h=i===t?10:1,c=new e.SortedSet;return r>-1&&(n[r]=a*s*h),Object.keys(l.tokenStore.get(i)).forEach(function(e){c.add(e)}),o.union(c)},new e.SortedSet);i.push(h)},this);var a=i.reduce(function(e,t){return e.intersect(t)}),l=new e.Vector(n);return a.map(function(e){return{ref:e,score:l.similarity(this.documentVector(e))}},this).sort(function(e,t){return t.score-e.score})},e.Index.prototype.documentVector=function(t){for(var o=this.documentStore.get(t),n=o.length,i=Array(this.corpusTokens.length),r=0;n>r;r++){var s=o.elements[r],a=this.tokenStore.get(s)[t].tf,l=this.idf(s);i[this.corpusTokens.indexOf(s)]=a*l}return new e.Vector(i)},e.Index.prototype.toJSON=function(){return{version:e.version,fields:this._fields,ref:this._ref,documentStore:this.documentStore.toJSON(),tokenStore:this.tokenStore.toJSON(),corpusTokens:this.corpusTokens.toJSON(),pipeline:this.pipeline.toJSON()}},e.Store=function(){this.store={},this.length=0},e.Store.load=function(t){var o=new this;return o.length=t.length,o.store=Object.keys(t.store).reduce(function(o,n){return o[n]=e.SortedSet.load(t.store[n]),o},{}),o},e.Store.prototype.set=function(e,t){this.store[e]=t,this.length=Object.keys(this.store).length},e.Store.prototype.get=function(e){return this.store[e]},e.Store.prototype.has=function(e){return e in this.store},e.Store.prototype.remove=function(e){this.has(e)&&(delete this.store[e],this.length--)},e.Store.prototype.toJSON=function(){return{store:this.store,length:this.length}},e.stemmer=function(){var e={ational:"ate",tional:"tion",enci:"ence",anci:"ance",izer:"ize",bli:"ble",alli:"al",entli:"ent",eli:"e",ousli:"ous",ization:"ize",ation:"ate",ator:"ate",alism:"al",iveness:"ive",fulness:"ful",ousness:"ous",aliti:"al",iviti:"ive",biliti:"ble",logi:"log"},t={icate:"ic",ative:"",alize:"al",iciti:"ic",ical:"ic",ful:"",ness:""},o="[^aeiou]",n="[aeiouy]",i=o+"[^aeiouy]*",r=n+"[aeiou]*",s="^("+i+")?"+r+i,a="^("+i+")?"+r+i+"("+r+")?$",l="^("+i+")?"+r+i+r+i,h="^("+i+")?"+n;return function(o){var r,c,u,p,d,f,g;if(3>o.length)return o;if(u=o.substr(0,1),"y"==u&&(o=u.toUpperCase()+o.substr(1)),p=/^(.+?)(ss|i)es$/,d=/^(.+?)([^s])s$/,p.test(o)?o=o.replace(p,"$1$2"):d.test(o)&&(o=o.replace(d,"$1$2")),p=/^(.+?)eed$/,d=/^(.+?)(ed|ing)$/,p.test(o)){var S=p.exec(o);p=RegExp(s),p.test(S[1])&&(p=/.$/,o=o.replace(p,""))}else if(d.test(o)){var S=d.exec(o);r=S[1],d=RegExp(h),d.test(r)&&(o=r,d=/(at|bl|iz)$/,f=RegExp("([^aeiouylsz])\\1$"),g=RegExp("^"+i+n+"[^aeiouwxy]$"),d.test(o)?o+="e":f.test(o)?(p=/.$/,o=o.replace(p,"")):g.test(o)&&(o+="e"))}if(p=/^(.+?)y$/,p.test(o)){var S=p.exec(o);r=S[1],p=RegExp(h),p.test(r)&&(o=r+"i")}if(p=/^(.+?)(ational|tional|enci|anci|izer|bli|alli|entli|eli|ousli|ization|ation|ator|alism|iveness|fulness|ousness|aliti|iviti|biliti|logi)$/,p.test(o)){var S=p.exec(o);r=S[1],c=S[2],p=RegExp(s),p.test(r)&&(o=r+e[c])}if(p=/^(.+?)(icate|ative|alize|iciti|ical|ful|ness)$/,p.test(o)){var S=p.exec(o);r=S[1],c=S[2],p=RegExp(s),p.test(r)&&(o=r+t[c])}if(p=/^(.+?)(al|ance|ence|er|ic|able|ible|ant|ement|ment|ent|ou|ism|ate|iti|ous|ive|ize)$/,d=/^(.+?)(s|t)(ion)$/,p.test(o)){var S=p.exec(o);r=S[1],p=RegExp(l),p.test(r)&&(o=r)}else if(d.test(o)){var S=d.exec(o);r=S[1]+S[2],d=RegExp(l),d.test(r)&&(o=r)}if(p=/^(.+?)e$/,p.test(o)){var S=p.exec(o);r=S[1],p=RegExp(l),d=RegExp(a),f=RegExp("^"+i+n+"[^aeiouwxy]$"),(p.test(r)||d.test(r)&&!f.test(r))&&(o=r)}return p=/ll$/,d=RegExp(l),p.test(o)&&d.test(o)&&(p=/.$/,o=o.replace(p,"")),"y"==u&&(o=u.toLowerCase()+o.substr(1)),o}}(),e.Pipeline.registerFunction(e.stemmer,"stemmer"),e.stopWordFilter=function(t){return-1===e.stopWordFilter.stopWords.indexOf(t)?t:void 0},e.stopWordFilter.stopWords=new e.SortedSet,e.stopWordFilter.stopWords.length=119,e.stopWordFilter.stopWords.elements=["a","able","about","across","after","all","almost","also","am","among","an","and","any","are","as","at","be","because","been","but","by","can","cannot","could","dear","did","do","does","either","else","ever","every","for","from","get","got","had","has","have","he","her","hers","him","his","how","however","i","if","in","into","is","it","its","just","least","let","like","likely","may","me","might","most","must","my","neither","no","nor","not","of","off","often","on","only","or","other","our","own","rather","said","say","says","she","should","since","so","some","than","that","the","their","them","then","there","these","they","this","tis","to","too","twas","us","wants","was","we","were","what","when","where","which","while","who","whom","why","will","with","would","yet","you","your"],e.Pipeline.registerFunction(e.stopWordFilter,"stopWordFilter"),e.TokenStore=function(){this.root={docs:{}},this.length=0},e.TokenStore.load=function(e){var t=new this;return t.root=e.root,t.length=e.length,t},e.TokenStore.prototype.add=function(e,t,o){var o=o||this.root,n=e[0],i=e.slice(1);return n in o||(o[n]={docs:{}}),0===i.length?(o[n].docs[t.ref]=t,this.length+=1,void 0):this.add(i,t,o[n])},e.TokenStore.prototype.has=function(e,t){var t=t||this.root,o=e[0],n=e.slice(1);return o in t?0===n.length?!0:this.has(n,t[o]):!1},e.TokenStore.prototype.getNode=function(e,t){var t=t||this.root,o=e[0],n=e.slice(1);return o in t?0===n.length?t[o]:this.getNode(n,t[o]):{}},e.TokenStore.prototype.get=function(e,t){return this.getNode(e,t).docs||{}},e.TokenStore.prototype.remove=function(e,t,o){var o=o||this.root,n=e[0],i=e.slice(1);if(n in o)return 0!==i.length?this.remove(i,t,o[n]):(delete o[n].docs[t],void 0)},e.TokenStore.prototype.expand=function(e,t){var o=this.getNode(e),n=o.docs||{},t=t||[];return Object.keys(n).length&&t.push(e),Object.keys(o).forEach(function(o){"docs"!==o&&t.concat(this.expand(e+o,t))},this),t},e.TokenStore.prototype.toJSON=function(){return{root:this.root,length:this.length}},e});