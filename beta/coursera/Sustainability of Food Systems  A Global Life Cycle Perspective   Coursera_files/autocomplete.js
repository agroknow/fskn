define(["jquery","backbone","underscore","js/lib/lunr","js/collections/topics","js/lib/util"],function(e,t,u,r,n,o){var i=[{id:"topic",label:"Courses",numDisplay:3},{id:"category",label:"Topics",numDisplay:3},{id:"instructor",label:"Instructors",numDisplay:3},{id:"university",label:"Universities",numDisplay:3}],s=t.Model.extend({_topicWeight:function(e){var t=.1,u=60,r=20;if(!e.get("open_course"))return t;var n=e.get("open_course").get("start_diff"),o=Math.abs(n);return n>=0?(1-t)*Math.exp(-o/u)+t:0>n?(1-t)*Math.exp(-o/r)+t:void 0},loadData:function(){var e=this;if(!this.get("deferredData")){var t=n.singletonReadAll().pipe(function(t,n){var i,s,a=[];for(t.each(function(t){s={id:a.length,type:"topic",name:t.get("name"),url:"course/"+t.get("short_name"),weight:e._topicWeight(t)},a.push(s)}),i=0;n.insts.length>i;i++){var c=n.insts[i];s={id:a.length,type:"instructor",name:o.concatName(c),url:c.short_name?"instructor/"+c.short_name:"instructor/~"+c.id,weight:1},a.push(s)}for(i=0;n.cats.length>i;i++){var l=n.cats[i];s={id:a.length,type:"category",name:l.name,url:"courses?cats="+l.short_name,weight:1},a.push(s)}for(i=0;n.unis.length>i;i++){var f=n.unis[i];f.display&&(s={id:a.length,type:"university",name:f.name,url:"/"+f.short_name,weight:1},a.push(s))}u.each(a,function(e){e.name_latinized=o.removeDiacritics(e.name)});var h=new r.Index;return h.field("name_latinized"),h.ref("id"),u.each(a,function(e){h.add(e)}),{items:a,searchIndex:h}});this.set("deferredData",t)}},search:function(e){return this.loadData(),this.get("deferredData").pipe(function(t){var n=t.items,s=t.searchIndex,a=[],c=s.search(o.removeDiacritics(e)),l=u.map(c,function(e){return n[e.ref].score=e.score*n[e.ref].weight,n[e.ref]}),f=u.groupBy(l,"type");a=a.concat(u.map(i,function(e){return f[e.id]=f[e.id]||[],f[e.id]=u.sortBy(f[e.id],function(e){return-e.score}),{label:e.label,items:u.first(f[e.id],e.numDisplay)}}));var h=r.tokenizer(o.removeDiacritics(e));return u.each(u.flatten(u.pluck(a,"items")),function(e){e.positions=[];for(var t=0;e.name.length>t;t++)e.positions.push(!1);u.each(h,function(t){for(var u=t.length;u>=1;u--){for(var r=!1,n=RegExp("(^| )"+t.substr(0,u),"gi");m=n.exec(e.name_latinized);){for(var o=0;u>o;o++)e.positions[m.index+o+(" "==m[1]?1:0)]=!0;r=!0}if(r)break}});for(var r="",n=!1,o=0;e.name.length>o;o++)e.positions[o]&&!n&&(r+="<strong>",n=!0),!e.positions[o]&&n&&(r+="</strong>",n=!1),r+=e.name[o];n&&(r+="</strong>"),e.nameHilighted=r}),a})}});return s});